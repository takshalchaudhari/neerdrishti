<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Neerdrishti – Pose Mapping (Stable)</title>

<!-- MQTT -->
<script src="paho-mqtt.js"></script>

<!-- THREE.JS (LOCKED, COMPATIBLE VERSIONS) -->
<script src="https://cdn.jsdelivr.net/npm/three@0.149.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.149.0/examples/js/controls/OrbitControls.js"></script>

<style>
body{
  margin:0;
  background:#050d12;
  color:#0f0;
  font-family:monospace;
  text-align:center;
}
canvas{background:#021;border-radius:8px}
#panels{display:flex;flex-wrap:wrap;justify-content:center}
#status{color:#ff0}
</style>
</head>

<body>

<h2>Neerdrishti – Phase 3-2 (Pose-Based Mapping)</h2>
<p id="status">Connecting…</p>

<div id="panels">
  <canvas id="map" width="420" height="300"></canvas>
  <div id="three" style="width:420px;height:420px"></div>
</div>

<script>
/* ================= CONFIG ================= */
const FORWARD_SPEED = 0.02;
const TURN_RATE = 0.002;
const ANGLES = {front:0,left:-30,right:30};
const MIN_CM = 20, MAX_CM = 300;
const MEDIAN_WINDOW = 5;
const EMA_ALPHA = 0.35;

/* ================= STATE ================= */
let pose = {x:0,y:0,theta:0};
let hist={front:[],left:[],right:[]};
let ema={front:0,left:0,right:0};
let lastMsg=0;
const worldPts=[];

/* ================= FILTER ================= */
function median(a){
  return [...a].sort((x,y)=>x-y)[Math.floor(a.length/2)];
}
function filter(k,v){
  if(v<MIN_CM||v>MAX_CM) return null;
  hist[k].push(v);
  if(hist[k].length>MEDIAN_WINDOW) hist[k].shift();
  if(hist[k].length<MEDIAN_WINDOW) return null;
  const m=median(hist[k]);
  ema[k]=ema[k]?EMA_ALPHA*m+(1-EMA_ALPHA)*ema[k]:m;
  return ema[k]/100;
}

/* ================= POSE ================= */
function updatePose(){
  pose.x+=FORWARD_SPEED*Math.cos(pose.theta);
  pose.y+=FORWARD_SPEED*Math.sin(pose.theta);
  pose.theta+=TURN_RATE;
}

/* ================= 2D MAP ================= */
const map=document.getElementById("map").getContext("2d");
function drawMap(){
  map.fillStyle="#011";
  map.fillRect(0,0,420,300);

  map.fillStyle="#0f0";
  worldPts.forEach(p=>{
    map.fillRect(210+p.x*20,150-p.y*20,3,3);
  });

  map.fillStyle="#f00";
  map.fillRect(210+pose.x*20,150-pose.y*20,6,6);

  requestAnimationFrame(drawMap);
}
drawMap();

/* ================= 3D ================= */
const scene=new THREE.Scene();
scene.background=new THREE.Color(0x020a0f);

const camera=new THREE.PerspectiveCamera(60,1,0.1,2000);
camera.position.set(0,4,8);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(420,420);
document.getElementById("three").appendChild(renderer.domElement);

const controls=new THREE.OrbitControls(camera,renderer.domElement);
controls.enableDamping=true;

scene.add(new THREE.GridHelper(20,20,0x00ff00,0x003300));

const geom=new THREE.BufferGeometry();
const pts=[];
const mat=new THREE.PointsMaterial({color:0x00ff00,size:0.05});
const cloud=new THREE.Points(geom,mat);
scene.add(cloud);

function add3D(x,y){
  pts.push(x,0,-y);
  geom.setAttribute("position",new THREE.Float32BufferAttribute(pts,3));
}

function render3D(){
  controls.update();
  renderer.render(scene,camera);
  requestAnimationFrame(render3D);
}
render3D();

/* ================= MQTT ================= */
const statusEl=document.getElementById("status");

const client=new Paho.Client(
  "4d679eb8c29c4e029130d4045c0c1a2e.s1.eu.hivemq.cloud",
  8884,
  "/mqtt",
  "web_"+Math.random().toString(16).slice(2)
);

client.onMessageArrived=m=>{
  const j=JSON.parse(m.payloadString);
  lastMsg=Date.now();
  updatePose();

  Object.keys(ANGLES).forEach(k=>{
    const d=filter(k,j[k]);
    if(!d) return;
    const a=pose.theta+ANGLES[k]*Math.PI/180;
    const wx=pose.x+d*Math.cos(a);
    const wy=pose.y+d*Math.sin(a);
    worldPts.push({x:wx,y:wy});
    add3D(wx,wy);
  });

  statusEl.innerText="Mapping (pose)";
};

client.onConnectionLost=()=>{
  statusEl.innerText="MQTT disconnected";
};

client.connect({
  useSSL:true,
  onSuccess:()=>{
    statusEl.innerText="Connected";
    client.subscribe("neerdrishti/sonar/map");
  },
  onFailure:()=>{
    statusEl.innerText="MQTT failed";
  }
});

setInterval(()=>{
  if(Date.now()-lastMsg>3000){
    statusEl.innerText="No data";
  }
},1000);
</script>

</body>
</html>
